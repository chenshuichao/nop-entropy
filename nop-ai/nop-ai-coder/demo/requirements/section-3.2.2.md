#  经营管理

##  用户故事列表

###  US-3.2.2-001:库房管理(Priority:1,Effort:2)
- Who: 服务公司管理员
- What: 管理服务公司下属的库房信息
- Why: 确保物资存储位置信息准确可用
- 关联用例: UC-3.2.2-001

###  US-3.2.2-002:每日菜单管理(Priority:1,Effort:3)
- Who: 服务公司运营人员
- What: 创建和管理每日执行的菜单计划
- Why: 确保每日供餐计划与食材需求匹配
- 关联用例: UC-3.2.2-002

###  US-3.2.2-003:出入库操作(Priority:1,Effort:4)
- Who: 库房管理员
- What: 执行物资的入库和出库操作
- Why: 准确记录物资流动，保持库存实时准确
- 关联用例: UC-3.2.2-003

###  US-3.2.2-004:单据锁定管理(Priority:2,Effort:2)
- Who: 库房主管
- What: 锁定已确认的出入库单据
- Why: 防止已确认数据被修改，保证财务数据完整性
- 关联用例: UC-3.2.2-004

###  US-3.2.2-005:盘库管理(Priority:2,Effort:3)
- Who: 库房管理员
- What: 执行库存盘点并生成盘盈/盘亏记录
- Why: 保证账面库存与实际库存一致
- 关联用例: UC-3.2.2-005

###  US-3.2.2-006:供应商结算(Priority:1,Effort:3)
- Who: 财务人员
- What: 基于入库单与供应商进行结算
- Why: 及时完成应付账款处理
- 关联用例: UC-3.2.2-006

###  US-3.2.2-007:经营数据管理(Priority:1,Effort:3)
- Who: 运营经理
- What: 管理订餐人数、经营成本及偏差分析
- Why: 监控经营绩效，优化成本控制
- 关联用例: UC-3.2.2-007,UC-3.2.2-008

##  用例列表

###  UC-3.2.2-001:管理库房信息(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/库房管理
- **参与者**：服务公司管理员（主要），学校管理员（次要/只读）
- **触发条件**：需要新增/修改/查看服务公司下属库房
- **使用频率**：低频

####  详细说明
[标准CRUD流程]

###  UC-3.2.2-002:管理每日菜单(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/每日菜单管理
- **参与者**：服务公司运营人员（主要），学校管理员（次要/只读）
- **触发条件**：需要为指定日期创建或修改菜单计划
- **使用频率**：高频（每日）

####  详细说明
**前置条件**：
1. 基础菜单数据已配置
2. 用户具有服务公司操作权限

**基本流程**：
1. 选择菜单日期 [涉及UI：日期选择器]
2. 从基础菜单模板库选择菜品 [涉及UI：菜单选择器]
3. 确认配料清单及数量 [涉及UI：配料表格]
4. 保存每日菜单计划 [涉及API：菜单保存接口]
5. 系统生成每日菜单记录

**异常流程**：
- 分支1：选择已结算日期 → 禁止修改并提示"该日期菜单已结算"
- 分支2：未选择有效菜品 → 提示"请至少选择一个菜品"

**后置条件**：
- 系统状态：新增daily_menu记录
- 数据变更：创建每日菜单及关联配料数据

###  UC-3.2.2-003:执行出入库操作(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/出入库管理
- **参与者**：库房管理员（主要），财务人员（次要）
- **触发条件**：发生物资进出库房
- **使用频率**：高频

####  详细说明
**前置条件**：
1. 库房和物资基础数据已维护
2. 当前用户有目标库房操作权限

**基本流程**：
1. 选择出入库类型（入库/出库）[涉及UI：类型切换]
2. 选择库房和供应商（入库时）[涉及UI：库房选择器]
3. 添加物资明细（扫码或手动选择）[涉及UI：物资选择器]
4. 输入单价和数量（自动计算金额）[涉及UI：金额计算器]
5. 保存出入库单据 [涉及API：出入库保存接口]
6. 系统更新库存数量

**异常流程**：
- 分支1：出库数量>当前库存 → 提示"库存不足，当前可用：X单位"
- 分支2：选择禁用供应商 → 不在可选列表显示

**后置条件**：
- 系统状态：生成in_out_main和in_out_detail记录
- 数据变更：更新inventory表物资数量

###  UC-3.2.2-004:锁定出入库单据(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/出入库管理
- **参与者**：库房主管
- **触发条件**：确认出入库单据无误后
- **使用频率**：中频

####  详细说明
**前置条件**：
1. 存在未锁定的出入库单据
2. 用户具有单据锁定权限

**基本流程**：
1. 在出入库列表选择目标单据 [涉及UI：单据列表]
2. 点击"锁定"操作按钮 [涉及UI：锁定按钮]
3. 系统验证单据完整性
4. 更新单据锁定状态为"已锁定" [涉及API：单据锁定接口]

**异常流程**：
- 分支1：单据明细为空 → 提示"请先添加物资明细"
- 分支2：重复锁定 → 提示"单据已锁定"

**后置条件**：
- 系统状态：单据锁定状态变更
- 数据变更：in_out_main.lock_status=1

###  UC-3.2.2-005:执行盘库操作(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/盘库管理
- **参与者**：库房管理员
- **触发条件**：定期库存盘点或异常检查
- **使用频率**：中频

####  详细说明
**前置条件**：
1. 选择目标库房
2. 库存数据已初始化

**基本流程**：
1. 选择目标库房和盘点日期 [涉及UI：库房选择器]
2. 录入物资实际盘点数量 [涉及UI：盘点表格]
3. 系统自动计算盘盈/盘差额 [涉及API：盈亏计算]
4. 确认生成盘盈入库单或盘亏出库单
5. 系统自动创建对应出入库记录

**异常流程**：
- 分支1：未选择库房 → 禁用提交按钮
- 分支2：差异率为零 → 提示"库存准确，无需生成单据"

**后置条件**：
- 系统状态：生成盘库差异单据
- 数据变更：创建in_out_main/in_out_detail，更新inventory

###  UC-3.2.2-006:供应商结算处理(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/供应商结算
- **参与者**：财务人员
- **触发条件**：到达结算周期或有临时结算需求
- **使用频率**：中频

####  详细说明
**前置条件**：
1. 存在未结清的入库单据
2. 供应商状态有效

**基本流程**：
1. 选择供应商查看未结算单据 [涉及UI：供应商筛选]
2. 勾选要结算的入库单 [涉及UI：结算列表]
3. 输入本次结算金额 [涉及UI：金额输入]
4. 确认结算并生成凭证 [涉及API：结算接口]
5. 更新入库单已结金额

**异常流程**：
- 分支1：结算金额>未结金额 → 提示"超出可结金额X元"
- 分支2：选择禁用供应商 → 显示禁用状态标识

**后置条件**：
- 系统状态：生成结算记录
- 数据变更：更新in_out_main.paid_amount

###  UC-3.2.2-007:管理经营基础数据(useCaseType:ui)

####  基本信息
- **菜单路径**：经营管理/经营数据
- **参与者**：运营经理
- **触发条件**：需要录入或更新经营数据
- **使用频率**：高频（每日）

####  详细说明
**前置条件**：
1. 选择目标日期范围
2. 具有数据编辑权限

**基本流程**：
1. 选择经营日期 [涉及UI：日期选择]
2. 录入或导入订餐人数 [涉及API：订餐系统集成]
3. 输入经营成本项（水电、人工等）[涉及UI：成本表单]
4. 保存经营数据 [涉及API：数据保存接口]

**异常流程**：
- 分支1：未录入必填项 → 标记红色边框提示
- 分支2：数值超范围 → 提示"请输入合理数值范围"

**后置条件**：
- 数据变更：创建/更新经营数据集

###  UC-3.2.2-008:生成日偏差报告(useCaseType:job)

####  基本信息
- **菜单路径**：N/A（后台任务）
- **参与者**：系统定时任务（主要），运营经理（查看）
- **触发条件**：每日营业结束后自动触发
- **使用频率**：高频（每日）

####  详细说明
**前置条件**：
1. 当日出入库数据已完成
2. 每日菜单计划已执行

**基本流程**：
1. 获取当日计划消耗量（基于每日菜单）
2. 获取实际出库量（基于出库单）
3. 计算物资消耗偏差率 [公式：(实际-计划)/计划×100%]
4. 生成偏差分析报告
5. 存储计算结果

**异常流程**：
- 分支1：关键数据缺失 → 发送告警通知
- 分支2：除零错误 → 标记"无计划数据"

**后置条件**：
- 数据变更：生成偏差分析记录

##  页面列表

###  PAGE-3.2.2-001:出入库单据页面(pageType:wizard)
**基本信息**：
- 菜单ID：biz_inout
- 模板参考：https://ant.design/components/steps-cn/
- 关联用例：UC-3.2.2-003

**功能模块**：
| 区域 | 组件 | 字段列表 | 行为 |
|------|------|----------|------|
| 头部 | 步骤导航 | 单据类型→基本信息→物资明细→完成 | 引导式流程 |
| 主体 | 表单分组 | 库房、供应商、经手人、日期 | 实时保存草稿 |
| 右侧 | 库存面板 | 物资编码、当前库存 | 选择物资时显示 |
| 底部 | 操作栏 | 保存、提交、取消 | 提交后启动审批 |

**状态说明**：
- 初始状态：显示空白表单，默认当前日期
- 交互状态：选择库房后加载库存信息
- 错误状态：校验失败字段红色高亮

###  PAGE-3.2.2-002:经营数据仪表盘(pageType:tabs)
**基本信息**：
- 菜单ID：biz_dashboard
- 关联用例：UC-3.2.2-007,UC-3.2.2-008

**功能模块**：
| 区域 | 组件 | 字段列表 | 行为 |
|------|------|----------|------|
| 顶部 | 日期筛选器 | 开始日期、结束日期 | 触发数据重载 |
| Tab1 | 数据录入表 | 日期、订餐数、水电费、人工费 | 行内编辑保存 |
| Tab2 | 偏差分析图 | 物资名称、计划量、实际量、偏差率 | 柱状图+表格 |
| 侧边 | 摘要卡片 | 总成本、人均成本、总偏差率 | 自动计算 |

**状态说明**：
- 初始状态：显示当月数据，默认激活数据录入Tab
- 交互状态：日期变更时所有组件联动刷新
- 错误状态：数据加载失败显示空状态提示

##  业务规则
**数据规则**：
- 库房编码：必须符合WH-{公司编码}-xxx格式
- 菜单日期：禁止选择过去72小时外的日期进行修改
- 出入库数量：必须>0且≤9999
- 结算金额：必须≤（总金额-已结金额）

**状态机规则**：
| 当前状态 | 允许操作 | 目标状态 | 条件 |
|----------|----------|----------|------|
| 草稿 | 编辑/提交 | 已提交 | 明细不为空 |
| 已提交 | 审核/退回 | 已审核/草稿 | 主管权限 |
| 已审核 | 锁定 | 已锁定 | - |
| 已锁定 | 无 | - | 禁止编辑 |

**计算规则**：
- 单据金额：Σ(物资单价×数量)
- 偏差率：((实际消耗量 - 计划消耗量)/计划消耗量)×100%
- 库存结余：当前库存 = 上期结余 + 入库总量 - 出库总量

##  安全需求
敏感字段：结算金额、单价、成本数据（需传输加密）
审计要求：出入库操作、结算操作、数据锁定操作需记录完整审计日志

##  待确认的问题
1. 订餐人数获取API的具体接口规范及调用频率限制
2. 盘库操作是否允许部分物资分批盘点
3. 偏差分析报告是否需要支持自定义维度（按菜品/按类别）
4. 历史数据修改的权限分级管控规则

##  数据库设计补充
**无新增或修改表结构**


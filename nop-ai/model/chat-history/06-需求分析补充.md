以下是对`05-需求分析反馈`的补充说明


### **一、AI生成与模型管理**
1. **DSL生成粒度控制**
- 文档提及“每次让AI生成并检查DSL的一个部分”，但未定义模块拆分规则：
  - **Q1**: DSL模块划分依据是什么？NOP定义了一系列DSL，比如orm.xml, api.xml等，不需要用户决定。每个DSL都有内置的生成提示词，用户可以在系统提示词的基础上进行局部改进。提示词需要统一作为提示词模板管理，它包含输入，输出配置。使用时根据提示词名称选择使用哪个提示词。提示词模板也需要有版本管理，提示词名称+version才构成最新的记录，通过id关联指定版本。
  - **Q2**: 局部生成的DSL片段如何保证跨模块一致性？（如ORM与API DSL的字段匹配）生成的DSL会包含app:useCaseNo，app:entityName等额外的元数据信息，可以根据它们将不同的DSL关联在一起，提示词中应该包含相关的所有DSL信息，从而保证一致性。

2. **多模型评分机制**
- 文档要求AI对不同版本DSL进行百分制评分：
  - **Q3**: 评分维度权重如何设定？（正确性/性能/可读性/合规性）
  - **Q4**: 评分是否依赖额外测试用例？若是，测试用例由谁提供？测试用例由AI生成，并且可以人工维护

---

### **二、核心功能细节**
3. **需求导入与结构化**
- Markdown/Excel导入功能需明确：
  - **Q5**: Excel文件是否需预定义模板？（如固定列名/Sheet结构）不需要事前确定结构，Nop平台有通用的Excel解析和导入功能，不需要考虑相关问题。
  - **Q6**: Markdown文档的标题层级是否对应需求分解规则？ 是的，Nop平台内置了Markdown的解析工具并自动按照层级进行分解

4. **历史版本管理**
- 文档要求版本回滚与差异对比：
  - **Q7**: 版本快照是否包含关联DSL的依赖项？（如修改A.xml时B.yml是否同步存档）不需要考虑不同DSL的同步问题，这个问题比较复杂，不好处理，由逻辑编排配置负责协调
  - **Q8**: 差异对比工具支持哪些格式？（文本Diff/可视化树对比）

---

### **三、非功能性需求量化**
5. **性能与可靠性**
- 需明确不可量化指标的实现路径：
  - **Q9**: “编译通过率≥95%”是否包含AI自动修复？若包含，修复次数上限是多少？ AI自动修复执行的次数可以配置进行修改
  - **Q10**: 异步任务超时机制如何设计？（如24小时未生成应用是否强制终止） 整个任务流程由NopTaskFlow控制，它可以配置超时时间。

6. **安全扫描深度**
- 文档提及独立安全扫描功能：
  - **Q11**: 扫描范围是否覆盖DSL生成的最终代码？（如SQL注入检测在DSL层还是编译后层）注入检测在DSL层面即可。
  - **Q12**: 漏洞库的更新策略？（内置规则库/联机更新）可以有一个内置的规则库

---

### **四、技术集成关键点**
7. **Nop平台集成**
- 需明确DSL到Nop的映射规则：
  - **Q13**: 生成的DSL是否需符合特定xdef元模型版本？版本冲突如何处理？不需要考虑版本冲突的问题
  - **Q14**: Nop的扩展点如何暴露给AI？（如是否允许AI调用Nop的`IoCContainer`） AI只处理DSL层面，不需要考虑Nop平台的扩展点。

8. **AI服务降级方案**
- 手工编辑DSL时的约束：
  - **Q15**: 手动修改是否需通过xdef元模型校验？若跳过校验如何保证生成可用性？ 所有DSL保存时都会自动校验有效性，满足有效性的DSL才能成功保存。
  - **Q16**: 降级模式下是否禁用部分AI功能？（如安全扫描） 安全扫描是一个可选功能。

---

### **五、数据与用户体验**
9. **操作轨迹记录**
- 文档要求记录AI交互过程：
  - **Q17**: 轨迹数据是否包含用户编辑动作？（如光标移动/文本删除）？不包含这种细节数据，只需要记录所有AI对话历史
  - **Q18**: 缓存标记为`false`时，相同prompt的请求是否仍计入训练数据？ 没有命中缓存的prompt会产生新的对话记录。

10. **多格式渲染机制**
- DSL可视化查看工具需明确：
  - **Q19**: 不同DSL类型（ORM/API）的渲染器是否可插拔？扩展接口如何定义？不需要考虑这个问题，这由底层Nop平台负责
  - **Q20**: Excel模型文件与DSL的双向同步如何实现？（修改Excel是否触发DSL更新）不需要考虑这个问题，由底层Nop平台负责

---

### **六、风险控制**
11. **第三方AI依赖**
- 文档假设“AI服务永远可用”，但需兜底方案：
  - **Q21**: 连续生成失败N次后是否触发本地轻量模型？ 连续生成失败超过一定次数后，自动中断。需要有一个执行日志表，其中可以查看到任务失败。
  - **Q22**: 模型返回格式错误时，是否尝试schema-guided修复？不用考虑这个问题，底层Nop平台会自动进行局部修正。

12. **DSL合规边界**
- 需防止AI生成无效DSL：
  - **Q23**: 是否配置DSL复杂度阈值？（如嵌套深度/节点数量） 这个暂时不用考虑，需要时可以在提示词中处理。
  - **Q24**: 领域特定约束（如金融合规规则）如何注入到生成过程中？ 通过需求文档和用例中的说明信息注入

---

> **关键建议**：
> - **提供DSL示例**：补充典型场景的输入需求→生成DSL→最终应用的端到端示例，明确各环节数据格式。通过提示词会提供DSL元模型和示例。需要定义一个知识库，可以保存各种不同格式的示例文件。
> - **定义错误码体系**：文档中的JSON错误格式需扩展完整错误码表（如`MODEL_VALIDATION_ERROR`）。 错误码格式为 XXX_YYY_ZZZ格式
> - **明确缓存策略**：AI结果缓存的生命周期和失效规则（如DSL元模型更新时是否清空缓存）。 不需要考虑这个问题。

【提示词说明】
* 模型：deepseek-r1

【提示词】
**角色与目标**： 作为资深软件专家，你的任务是将提供的需求分析文档信息整理为结构化、规范化的格式。

**核心指令**：

- 严格保持原始信息完整性： 仅使用文档中提供的信息进行整理。严禁添加任何文档中未明确包含的假设、解释或额外细节。
- 严禁删除任何信息： 确保原始文档中的所有需求、描述、约束和关键点都被完整包含在整理后的输出中。
- 规范化格式输出： 将信息组织成清晰、一致、易于理解的格式（例如：需求编号、需求描述、来源、类型、优先级、验收标准等结构化字段）。选择最符合信息特性和行业标准的格式。

【待整理文档】
以下是根据`03-综合分析框架`初步填写的结果

# AI智能代码生成软件需求文档

软件功能：AI辅助智能代码生成系统，用户输入需求即可自动生成各种DSL模型文件，用户可以进行局部调整，最后点击生成即可生成一个完整应用
技术背景：单体应用，Java Web应用，面向一般技术人员。

#### **1. 业务目标与范围**

- **核心价值**
  缩短DSL建模到应用生成的周期，降低技术门槛
  通过AI生成可调整的DSL模型，输出完整应用
- **范围边界**
  ✅ 包含：需求输入 → AI生成DSL → 可视化编辑 → 应用生成 → 结果导出/下载
  ❌ 不包含：
  - 版本协作/用户权限管理
  - 应用部署/移动端支持
  - 团队协作功能

---

#### **2. 用户角色与场景**

| 角色      | 使用场景                        | 关键需求                         | 待澄清问题（SA）                        |
|---------|-----------------------------|------------------------------|----------------------------------|
| 技术工程师   | 快速生成原型应用，并可以通过调整DSL模型来进行完善  | 实时预览生成结果                     | 技术背景？掌握SQL和JavaScript            |
| 数据分析师   | 创建报表模板DSL                   | 自然语言需求示例库                    | 是否需要角色权限？不需要考虑权限问题，底层框架将统一解决权限问题 |
| 需求分析工程师 | 对用户输入的原始需求进行细化，并设计业务用例和测试用例 | AI初步生成结果，用户可以选择重新生成或者让AI尝试改进 | *是否需团队共享？* 需要                    |

---

#### **3. 核心功能需求**

**3.1 智能需求输入**

- 支持方式：自然语言/结构化表单/关键词标签（
- 问题清单：
  - Q4: 是否支持文件导入（Markdown/Excel）？支持Markdown文件和Excel模型文件的导入
  - Q5: 是否需多轮需求澄清（AI追问模糊点）？
    每个DSL都是AI自动生成初步版本，然后提供一系列按钮，让客户选择是否让AI继续改进。改进过程会产生一系列历史版本，用户可以选择最终使用哪个版本。
    用户还可以选择同时用不同的AI模型针对同一个提示词执行生成。每个DSL模型应该有一个评分，可以由AI模型对不同版本进行评分，百分制。

**3.2 AI生成DSL模型**

- 支持语言：SQL/Java/JavaScript/XML/YAML/Markdown/自定义DSL
- 关键决策：
  - Q7: AI服务采用第三方API（OpenAI）或自研模型？
    采用第三方API，需要有一个模型管理模块。每个模型有一个内部使用的name，每个生成的DSL都记录这个modelName，但是并不需要和模型对象建立关联，这是一种弱联系。
  - 可靠性要求：生成代码编译通过率 ≥95% 。因为是生成DSL，可以自动根据元模型对DSL进行检查和进行局部更正，并且可以主动控制DSL的复杂程度。比如每次让AI生成并检查DSL的一个部分。

**3.3 模型编辑与调整**

- 问题清单：
  - Q8: 是否需实时预览调整效果？不需要可视化编辑。每个DSL都配备有对应的可视化查看工具，生成后重新渲染即可。
  - Q9: 是否支持版本回滚/差异对比？需要内置版本管理功能，并且提供内置的差异比较工具。

**3.4 应用生成与导出**

- 输出类型：Web服务/批处理作业/API端点
- 技术栈：
  - Q10: 是否强制Spring Boot/React等？并不使用这些框架，底层基于Nop低代码平台，在这个平台中开发只需要编写各类DSL
  - Q11: 压缩包下载或直推Git仓库？生成的DSL存放在数据库中，按照目录结构管理，可以作为zip包下载到本地。

- 验收标准示例：
  ```gherkin
  当 输入“创建一个信用卡调额服务”
  则 生成数据库定义以及对应的后台服务流程DSL
  ```

---

#### **4. 非功能性需求**

| 类型  | 具体指标                                                                     | 问题清单（SA）                                       |
|-----|--------------------------------------------------------------------------|------------------------------------------------|
| 性能  | DSL生成响应不限制时间，可以异步执行                                                      | Q12: 响应阈值是否可调整？因为需求可能比较复杂，不强制要求即时生成            |
|     | 应用生成在24小时以内完成                                                            |                                                |
| 安全性 | 输入内容过滤XSS/SQL注入等问题不需要考虑                                                  | Q14: 是否需用户认证？              不需要考虑这个问题，底层框架会统一处理 |
|     | *AI生成的代码需要提供一个安全扫描功能*                                                    | Q15: 漏洞扫描深度？ AI自动判断是否存在安全漏洞，将这个作为一个独立功能点       |
| 可用性 | *内置DSL语法帮助*，DSL使用xdef元模型来进行语法自动校验，并提供语法提示                                | Q16: 帮助文档覆盖范围？由AI自动生成使用文档，这也是一个独立的功能点          |
|     | *离线编辑支持*                       ， DSL可以导出后离线编辑                            | Q17: 离线功能优先级？            离线功能优先级很低             |
| 可靠性 | 生成应用最低可用标准？ 自动生成测试用例来进行校验。因为底层基于NopORM引擎，所以可以让AI自动生成所有数据库模拟数据，和API请求响应消息 | *编译通过率≥95%*                                    |

---

#### **5. 技术约束**

- 后端架构：基于Nop平台的Web单体应用
- 前端框架：
  - 推荐：Vue3 + Monaco Editor + AMIS前端低代码
  - 约束：是否强制特定技术？强制要求使用以上技术
- 兼容性：
  - Q20: 浏览器兼容要求？不用考虑
- 依赖：Java 17+环境

---

#### **6. 集成与扩展**

| 类别     | 需求                                               | 问题清单                             |
|--------|--------------------------------------------------|----------------------------------|
| 认证集成   | 不需要考虑，底层平台统一处理                                   | 是否MVP必需？是                        |
| AI模型扩展 | 支持GPT/Claude/本地模型                                | Q23: 插件机制设计？ 通过后端管理的模型链接进行REST调用 |
| 工程化集成  | 预留API接入点（如Jenkins）？不需要考虑这个问题                     | Q24: API开放范围？所有API都会自动开放         |
| 降级方案   | AI失败时提供手动DSL模板？是的，可以手工直接录入DSL，或者手工修改，修改要产生新的历史版本 | Q25: 降级触发条件？ 任何AI自动生成内容都可以手工编辑   |

---

#### **7. 数据管理**

- 存储策略：
  - 用户DSL文件是否持久化？保存到数据库中
  - 需求历史记录保存需求？需求本身需要进行结构化管理。需要首先根据用户输入的简短需求生成一个完整细化的需求，并按照章节分解保存，然后针对每个功能模块生成一系列用例，再根据用例生成API定义和实现等。
- 安全规范：
  - 敏感数据处理（如数据库密码）？不需要考虑这些问题，由底层框架统一处理。
  - DSL文件加密存储要求？不需要存储加密

---

#### **8. 用户体验关键点**

- 错误处理机制：
  ```json
  {
    "error_type": "SYNTAX_ERROR",
    "position": { "line": 12, "column": 5 },
    "suggested_fix": "Missing closing bracket"
  }
  ```
- 交互设计：
  - 实时预览与编辑同步？
    目前编辑完成后点击保存再更新渲染。一个DSL可能存在多种展现形式，比如orm.xml可以用Html表格形式查看，可以用XML格式查看，可以下载Excel格式的模型文件等。不同的DSL文件对应不同的view，这个由内置的配置文件来控制。
  - *用户操作轨迹记录（用于优化AI）*？
    所有AI交互过程都需要详细记录，这独立于DSL的版本记录。并且AI交互消息还需要定义一个可缓存标记，缺省为true，如果发现同样的prompt，则直接返回缓存结果。如果可缓存标记设置为false，则不会将它作为结果返回。

---

#### **9. 假设与依赖**

- 关键依赖：
  - AI服务可用性 ≥99% ？ 可以假定AI服务永远可用。
  - DSL模板约束降低AI幻觉
- 风险假设：
  - 高频需求模板缓存失效
  - 第三方AI服务响应延迟？不用考虑

以下是对`05-需求分析反馈`的补充说明


### **一、AI生成与模型管理**
1. **DSL生成粒度控制**
- 文档提及“每次让AI生成并检查DSL的一个部分”，但未定义模块拆分规则：
  - **Q1**: DSL模块划分依据是什么？NOP定义了一系列DSL，比如orm.xml, api.xml等，不需要用户决定。每个DSL都有内置的生成提示词，用户可以在系统提示词的基础上进行局部改进。提示词需要统一作为提示词模板管理，它包含输入，输出配置。使用时根据提示词名称选择使用哪个提示词。提示词模板也需要有版本管理，提示词名称+version才构成最新的记录，通过id关联指定版本。
  - **Q2**: 局部生成的DSL片段如何保证跨模块一致性？（如ORM与API DSL的字段匹配）生成的DSL会包含app:useCaseNo，app:entityName等额外的元数据信息，可以根据它们将不同的DSL关联在一起，提示词中应该包含相关的所有DSL信息，从而保证一致性。

2. **多模型评分机制**
- 文档要求AI对不同版本DSL进行百分制评分：
  - **Q3**: 评分维度权重如何设定？（正确性/性能/可读性/合规性）
  - **Q4**: 评分是否依赖额外测试用例？若是，测试用例由谁提供？测试用例由AI生成，并且可以人工维护

---

### **二、核心功能细节**
3. **需求导入与结构化**
- Markdown/Excel导入功能需明确：
  - **Q5**: Excel文件是否需预定义模板？（如固定列名/Sheet结构）不需要事前确定结构，Nop平台有通用的Excel解析和导入功能，不需要考虑相关问题。
  - **Q6**: Markdown文档的标题层级是否对应需求分解规则？ 是的，Nop平台内置了Markdown的解析工具并自动按照层级进行分解

4. **历史版本管理**
- 文档要求版本回滚与差异对比：
  - **Q7**: 版本快照是否包含关联DSL的依赖项？（如修改A.xml时B.yml是否同步存档）不需要考虑不同DSL的同步问题，这个问题比较复杂，不好处理，由逻辑编排配置负责协调
  - **Q8**: 差异对比工具支持哪些格式？（文本Diff/可视化树对比）

---

### **三、非功能性需求量化**
5. **性能与可靠性**
- 需明确不可量化指标的实现路径：
  - **Q9**: “编译通过率≥95%”是否包含AI自动修复？若包含，修复次数上限是多少？ AI自动修复执行的次数可以配置进行修改
  - **Q10**: 异步任务超时机制如何设计？（如24小时未生成应用是否强制终止） 整个任务流程由NopTaskFlow控制，它可以配置超时时间。

6. **安全扫描深度**
- 文档提及独立安全扫描功能：
  - **Q11**: 扫描范围是否覆盖DSL生成的最终代码？（如SQL注入检测在DSL层还是编译后层）注入检测在DSL层面即可。
  - **Q12**: 漏洞库的更新策略？（内置规则库/联机更新）可以有一个内置的规则库

---

### **四、技术集成关键点**
7. **Nop平台集成**
- 需明确DSL到Nop的映射规则：
  - **Q13**: 生成的DSL是否需符合特定xdef元模型版本？版本冲突如何处理？不需要考虑版本冲突的问题
  - **Q14**: Nop的扩展点如何暴露给AI？（如是否允许AI调用Nop的`IoCContainer`） AI只处理DSL层面，不需要考虑Nop平台的扩展点。

8. **AI服务降级方案**
- 手工编辑DSL时的约束：
  - **Q15**: 手动修改是否需通过xdef元模型校验？若跳过校验如何保证生成可用性？ 所有DSL保存时都会自动校验有效性，满足有效性的DSL才能成功保存。
  - **Q16**: 降级模式下是否禁用部分AI功能？（如安全扫描） 安全扫描是一个可选功能。

---

### **五、数据与用户体验**
9. **操作轨迹记录**
- 文档要求记录AI交互过程：
  - **Q17**: 轨迹数据是否包含用户编辑动作？（如光标移动/文本删除）？不包含这种细节数据，只需要记录所有AI对话历史
  - **Q18**: 缓存标记为`false`时，相同prompt的请求是否仍计入训练数据？ 没有命中缓存的prompt会产生新的对话记录。

10. **多格式渲染机制**
- DSL可视化查看工具需明确：
  - **Q19**: 不同DSL类型（ORM/API）的渲染器是否可插拔？扩展接口如何定义？不需要考虑这个问题，这由底层Nop平台负责
  - **Q20**: Excel模型文件与DSL的双向同步如何实现？（修改Excel是否触发DSL更新）不需要考虑这个问题，由底层Nop平台负责

---

### **六、风险控制**
11. **第三方AI依赖**
- 文档假设“AI服务永远可用”，但需兜底方案：
  - **Q21**: 连续生成失败N次后是否触发本地轻量模型？ 连续生成失败超过一定次数后，自动中断。需要有一个执行日志表，其中可以查看到任务失败。
  - **Q22**: 模型返回格式错误时，是否尝试schema-guided修复？不用考虑这个问题，底层Nop平台会自动进行局部修正。

12. **DSL合规边界**
- 需防止AI生成无效DSL：
  - **Q23**: 是否配置DSL复杂度阈值？（如嵌套深度/节点数量） 这个暂时不用考虑，需要时可以在提示词中处理。
  - **Q24**: 领域特定约束（如金融合规规则）如何注入到生成过程中？ 通过需求文档和用例中的说明信息注入

---

> **关键建议**：
> - **提供DSL示例**：补充典型场景的输入需求→生成DSL→最终应用的端到端示例，明确各环节数据格式。通过提示词会提供DSL元模型和示例。需要定义一个知识库，可以保存各种不同格式的示例文件。
> - **定义错误码体系**：文档中的JSON错误格式需扩展完整错误码表（如`MODEL_VALIDATION_ERROR`）。 错误码格式为 XXX_YYY_ZZZ格式
> - **明确缓存策略**：AI结果缓存的生命周期和失效规则（如DSL元模型更新时是否清空缓存）。 不需要考虑这个问题。

